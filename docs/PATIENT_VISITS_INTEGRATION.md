# 🏥 Интеграция визитов в карточку пациента

## ✅ Реализовано

### 1. **Улучшенная форма назначений (Prescriptions)**

#### Константы для частоты и длительности
- ✅ `prescription.constants.ts` - Предопределенные опции для:
  - **Частота приема**: 1-4 раза в день, каждые 4/6/8/12 часов, утро/вечер, до/после еды, по необходимости
  - **Длительность**: 3/5/7/10/14/21/30 дней, постоянно
  
#### Зачем это нужно?
- 📱 **Напоминания**: В будущем можно настроить автоматические SMS/Push уведомления
- 📊 **Аналитика**: Структурированные данные для отчетов
- 🔔 **Автоматизация**: Расчет дат приема, контроль соблюдения режима

#### Форма с select полями
```typescript
// Вместо текстовых полей:
<Input placeholder="2 раза в день" />

// Теперь select с опциями:
<Select>
  <SelectItem value="2_TIMES_DAY">2 раза в день</SelectItem>
  <SelectItem value="AFTER_MEAL">После еды</SelectItem>
  ...
</Select>
```

---

### 2. **Компонент визитов пациента**

#### `PatientVisits` (`patient-visits.tsx`)
- ✅ Таблица с историей всех визитов пациента
- ✅ Кнопка "Записать на прием" - открывает форму создания
- ✅ Форма **БЕЗ** выбора пациента (уже известен)
- ✅ При создании редирект на `/cabinet/patients/{id}/visit/{visitId}`

**Особенности:**
- Фильтрация по `patientId` автоматически (backend поддерживает)
- Пустое состояние с call-to-action
- Быстрый просмотр визита

---

### 3. **Детальная страница визита внутри карточки пациента**

#### Маршрут: `/cabinet/patients/[id]/visit/[visitId]`

**Структура страницы:**

```
┌─────────────────────────────────────────┐
│ ← Назад   Детали приема    [СТАТУС] [Завершить] │
├─────────────────────────────────────────┤
│                                         │
│  ┌──────────────┐  ┌──────────────┐    │
│  │   Пациент    │  │     Врач     │    │
│  │  ФИО, возраст│  │  ФИО, ID     │    │
│  └──────────────┘  └──────────────┘    │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │    Примечания к приему          │   │
│  │  (жалобы, анамнез)              │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ──────────────────────────────────    │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  💊 Назначения                  │   │
│  │  [+ Добавить назначение]        │   │
│  │                                 │   │
│  │  Таблица с назначениями:        │   │
│  │  - Препарат                     │   │
│  │  - Дозировка                    │   │
│  │  - Частота (из select)          │   │
│  │  - Длительность (из select)     │   │
│  │  - Дата создания                │   │
│  │  - [Удалить] (если IN_PROGRESS) │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ──────────────────────────────────    │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  🧪 Направления на анализы      │   │
│  │  [+ Добавить направление]       │   │
│  │                                 │   │
│  │  Таблица с направлениями:       │   │
│  │  - Анализ                       │   │
│  │  - Статус (badge)               │   │
│  │  - Дата создания                │   │
│  │  - [Удалить] (если IN_PROGRESS) │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

**Дизайн:**
- 🎨 Карточки с иконками для секций
- 📊 Разделители между блоками
- 🎯 Читаемая типографика
- ✨ Условный рендеринг (показывать кнопки только если IN_PROGRESS)

---

### 4. **Интеграция в страницу пациента**

#### Новый таб "Визиты"
```typescript
<TabsList className="grid w-full grid-cols-5">
  <TabsTrigger value="overview">Обзор</TabsTrigger>
  <TabsTrigger value="profile">Профиль</TabsTrigger>
  <TabsTrigger value="visits">Визиты</TabsTrigger>      // ← Новый!
  <TabsTrigger value="appointments">Записи</TabsTrigger>
  <TabsTrigger value="history">История</TabsTrigger>
</TabsList>
```

---

## 🎯 User Flow

### Создание визита из карточки пациента

```
1. Открыть карточку пациента
   → /cabinet/patients/{id}

2. Перейти на таб "Визиты"

3. Нажать "Записать на прием"
   ↓
   Открывается Dialog с формой
   - Селектор ПАЦИЕНТА скрыт (уже известен!)
   - Селектор врача
   - Дата визита
   - Примечания

4. Заполнить и нажать "Начать прием"
   ↓
   Визит создается со status = "IN_PROGRESS"
   ↓
   Редирект на:
   /cabinet/patients/{patientId}/visit/{visitId}

5. На детальной странице:
   - Добавить назначения (через Dialog)
   - Добавить направления на анализы
   - Заполнить примечания
   - Нажать "Завершить прием"
   ↓
   Status → "COMPLETED"
   ↓
   Визит сохранен в истории
```

---

## 📊 Backend API

### Используемые endpoints:

```typescript
// Визиты
GET    /api/v1/visits?patientId={id}  // Список визитов пациента
POST   /api/v1/visits                 // Создать визит
GET    /api/v1/visits/:id             // Детали визита
PATCH  /api/v1/visits/:id/status      // Завершить визит

// Назначения
POST   /api/v1/prescriptions          // Добавить назначение
GET    /api/v1/prescriptions/visit/:visitId
DELETE /api/v1/prescriptions/:id

// Направления
POST   /api/v1/lab-orders
GET    /api/v1/lab-orders/visit/:visitId
DELETE /api/v1/lab-orders/:id
```

**Backend уже поддерживает фильтр по patientId!** ✅

---

## 🔧 Технические детали

### Адаптация VisitForm

```typescript
type VisitFormProps = {
  mode: "create" | "edit";
  patientId?: string;  // ← Новый проп!
  // ...
};

// Если patientId передан:
// 1. Скрывает селектор пациента
// 2. Предзаполняет patientId в форме
// 3. Редиректит на patients/{patientId}/visit/{visitId}
```

### Conditional rendering

```typescript
{!prefilledPatientId && (
  <FormField name="patientId">
    <PatientSelectField {...field} />
  </FormField>
)}
```

### Smart redirect

```typescript
if (prefilledPatientId) {
  router.push(`/cabinet/patients/${prefilledPatientId}/visit/${visit.id}`);
} else {
  router.push(`/cabinet/visits/${visit.id}`);
}
```

---

## 🚀 Как использовать

### 1. Откройте карточку пациента
```
http://localhost:3000/cabinet/patients/{patient-id}
```

### 2. Перейдите на таб "Визиты"

### 3. Нажмите "Записать на прием"

### 4. Заполните форму:
- ✅ Врач (обязательно)
- ✅ Дата (опционально, по умолчанию текущая)
- ✅ Примечания (опционально)

### 5. После создания:
- Добавьте назначения с **четкой частотой** и **длительностью**
- Добавьте направления на анализы
- Завершите прием

---

## 📝 Преимущества новой реализации

### ✅ Структурированные данные
- Частота и длительность в формате enum
- Готово для автоматизации напоминаний
- Легко фильтровать и анализировать

### ✅ Улучшенный UX
- Не нужно вводить пациента вручную
- Контекст сохраняется (все в карточке пациента)
- Красивая детальная страница

### ✅ Готово к масштабированию
- Можно добавить расчет дат приема
- Интеграция с системой напоминаний
- История изменений назначений

---

## 🎨 Будущие улучшения

1. **Напоминания пациентам**
   - SMS/Push за N часов до приема
   - Уведомления о необходимости принять лекарство
   - Основано на frequency и duration

2. **Календарь приема препаратов**
   - Визуализация графика приема
   - Отметки о выполнении
   - Статистика соблюдения режима

3. **Шаблоны назначений**
   - Сохранить часто используемые комбинации
   - Быстрое добавление стандартных схем

4. **Экспорт рецепта**
   - PDF с назначениями
   - QR-код для аптеки
   - Печать протокола визита

---

## ✅ Чеклист готовности

- [x] Константы частоты и длительности
- [x] Select поля в форме назначений
- [x] Компонент PatientVisits
- [x] Детальная страница визита в контексте пациента
- [x] Интеграция в таб пациента
- [x] Скрытие селектора пациента при создании
- [x] Smart redirect после создания
- [x] Красивый дизайн детальной страницы
- [x] Условный рендеринг кнопок (IN_PROGRESS only)
- [x] Экспорты констант

---

## 🎉 Готово к использованию!

Запустите `pnpm dev` и протестируйте полный flow создания визита из карточки пациента с добавлением назначений через новые структурированные select поля!
